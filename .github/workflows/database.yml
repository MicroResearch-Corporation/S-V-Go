name: Build SVG Database

on:
  push:
    paths:
      - "src/svg/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Generate Metadata JSON
        run: |
          node <<'EOF'
          const fs = require("fs");
          const path = require("path");

          // Configuration
          const ROOT = "src/svg";
          const OUT = "db.json";
          
          // Check if directory exists
          if (!fs.existsSync(ROOT)) {
            console.error(`Error: Directory "${ROOT}" not found.`);
            process.exit(1);
          }

          // Recursive function to find all SVGs
          function walk(dir) {
            let results = [];
            const list = fs.readdirSync(dir);
            list.forEach(file => {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              if (stat && stat.isDirectory()) {
                results = results.concat(walk(filePath));
              } else {
                if (file.toLowerCase().endsWith(".svg")) {
                  results.push(filePath);
                }
              }
            });
            return results;
          }

          console.log("Scanning files...");
          const files = walk(ROOT);
          
          // Sort files alphabetically to ensure ID order remains stable across runs
          files.sort();

          console.log(`Found ${files.length} SVGs. Generating JSON...`);

          const images = files.map((file, index) => {
            const name = path.basename(file, ".svg");
            // ID Generation: 000 + index. 
            // Using padStart(5, '0') ensures 00000, 00001... 07550 etc.
            // Adjust '5' if you want more or less padding.
            const id = String(index).padStart(5, '0');

            return {
              name: name,
              class: name,
              id: id
            };
          });

          // Custom JSON construction to keep objects on single lines
          // Standard JSON.stringify(obj, null, 2) expands objects to multiple lines.
          const lines = images.map(img => `    ${JSON.stringify(img)}`);
          
          // Assemble the final string
          const finalContent = `{\n  "total": ${images.length},\n  "generated_at": "${new Date().toISOString()}",\n  "images": [\n${lines.join(",\n")}\n  ]\n}`;

          fs.writeFileSync(OUT, finalContent);
          console.log("Done.");
          EOF

      - name: Deploy to Database Branch
        run: |
          # Move generated file to temp location
          cp db.json /tmp/db.json
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if 'database' branch exists, otherwise create orphan
          git fetch origin
          if git show-ref --verify --quiet refs/remotes/origin/database; then
            git checkout -f database
            git reset --hard origin/database
          else
            git checkout --orphan database
          fi
          
          # clean the branch to hold only the json file
          git rm -rf . || true
          
          # Restore the generated JSON
          cp /tmp/db.json db.json
          
          git add db.json
          git commit -m "update: svg database [skip ci]" || echo "No changes to commit"
          git push origin database --force
